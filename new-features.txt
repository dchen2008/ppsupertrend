
New enhance the bot: adopt 3hours's PP SuperTrend buy/sell signal as bull/bear marketing sign.
  1. Supports the new command-line argument format (at=, fr=, tf=)
  2. Loads YAML configuration from account directories
  3. Checks 3H PP SuperTrend for market direction (bull/bear)
  4. Implements take profit logic based on risk/reward ratios according to market trend

Detail:
Pls change run cmd from:
  ./scripts/auto_trade.sh EUR_USD tf:5m sl:SuperTrend account1 
to: 
  ./scripts/auto_trade.sh at=account1 fr=EUR_USD tf=5m

The script will auto overwrite more params from ./account1/config.yaml (optional for other format if you think it is more easy)
The overwrite config includes:
check_interval: 60 (seconds), every 60s will check 3H's pp SuperTrend, and 5mins/15mins pp SuperTrend signals, etc.

marketing:
  indicator:
  - ppsupertrend (means: 3hours PP supertrend buy/sell signal as bull/bear marketing signal)
  - 3h

stoploss:
 trailing:PPSuperTrend  (which trailing 5min or 15mins's pp supertrend)
 
risk_reward:
  bear:
    sell=1.2
    buy=0.6
  bull:
    sell:0.6
    buy:1.2

Above risk reward ration implement logic:

During "bear" marketing trend: 
    5min/15m's sell postion, take profit risk/reward ratio: 1.2
    5min/15m's buy postion, take profit risk/reward ratio: 0.6

During "bull" marketing trend: 
    5min/15m's sell postion, take profit risk/reward ratio: 0.6
    5min/15m's buy postion, take profit risk/reward ratio: 1.2

e.g.:
During "bear" marketing trend: running ./scripts/auto_trade.sh at=account1 fr=EUR_USD tf=5m
    when sell postion reach 1.2 risk/reward ratio, take profit immediately
    when buy postion reach 0.6 risk/reward ratio, take profit immediately

During "bull" marketing trend: running ./scripts/auto_trade.sh at=account1 fr=EUR_USD tf=5m
    when sell postion reach 0.6 risk/reward ratio, take profit immediately
    when buy postion reach 1.2 risk/reward ratio, take profit immediately
 small profit(0.6))



2. CSV log enhancement:

Pls enhance csv file output colums as:
tradeID,market,        action,                    pp_sign,   pp_sign_time,       order_time,          close_time,          duration(m), open_position,               entry_price, stop_loss, highest_pl, lowest_pl,  realized_pl, accountBalance
700, bear|bull,  NEW_ORDER|CLOSE|EXTERNAL_CLOSE,SHORT|LONG, 2026-01-09 05:43:33, 2026-01-09 05:43:35, 2026-01-09 05:43:35,  95,     "EUR_USD SHORT -36,531 units",  1.16365,    1.16458,    +$210.00,  -$85.08,      +$115.00,  $499,777.30

The tradeID's value should be same as: OANDA API response "Trade ID"
open_position: should be same as OANDA API response: Open Position: EUR_USD SHORT -36,531 units
if the column same as OANDA API response, should keep same value as OANDA.
About highest_pl, lowest_pl, when the position live there 150mins, running many candles, when price run high/lower, pls calculate highest/lowest PL into here.
This info(highest_pl, lowest_pl) are very important to measure the take profit risk/reward ratio reasonable late data analyse.

One tradeID should have multiple rows into this CSV, e.g.: tradeID: 700
tradeID, market,  action,    pp_sign,   pp_sign_time,        order_time,          close_time,        duration(m), open_position,               entry_price, stop_loss, highest_pl, lowest_pl,  realized_pl, accountBalance
700, bear,         NEW_ORDER,  SHORT,  2026-01-09 05:43:33,  2026-01-09 05:43:35, N/A,                  N/A,     "EUR_USD SHORT -36,531 units",  1.16365,    1.16458,    +$10.00,  -$15.08,      N/A,      $499,777.30
700, bear,         CLOSE,      SHORT,  2026-01-09 05:43:33,  2026-01-09 05:43:35, 2026-01-09 15:43:35,  145,     "EUR_USD SHORT -36,531 units",  1.16365,    1.16780,    +$210.00,  -$85.08,     +$115.00,  $499,777.30

After bot restart, pls call OANDA API get tradeID and other info, and read CSV, pls don't duplicate more rows in CSV.

Here is OANDA API response payload:
  - Account Balance: $499,777.30
  - Open Position: EUR_USD SHORT -36,531 units
  - Entry Price: 1.16365
  - Stop Loss: 1.16458
  - Unrealized P&L: +$16.07
  - Total P&L: -$1,594.96
  - Trade ID: 700

  The new CSV structure includes these columns:
  - tradeID - OANDA trade ID (matches API response)
  - market - Market trend (bear/bull/neutral)
  - action - NEW_ORDER/CLOSE/EXTERNAL_CLOSE
  - pp_sign - Position direction (SHORT/LONG)
  - pp_sign_time - Timestamp when signal generated
  - order_time - When order was placed
  - close_time - When position closed
  - duration(m) - Duration in minutes
  - open_position - Description like "EUR_USD SHORT -36,531 units"
  - entry_price - Entry price
  - stop_loss - Stop loss level
  - highest_pl - Highest P&L reached during trade lifetime
  - lowest_pl - Lowest P&L reached during trade lifetime
  - realized_pl - Final realized P&L
  - accountBalance - Account balance


3. Each order use dynamic position size
Pls put below config into config.yaml
position_sizing:
  use_dynamic: true
  bear: (it is 3H PP sign)
    short_risk_per_trade: 300   # if 5min/15min's PP sign is SHORT, risk $300 per trade
    long_risk_per_trade: 100    # if 5min/15min's PP sign is LONG, risk $100 per trade
  bull:
    short_risk_per_trade: 100   # if 5min/15min's PP sign is SHORT, risk $100 per trade
    long_risk_per_trade: 300    # if 5min/15min's PP sign is LONG, risk $300 per trade

 Key Enhancements:

  1. Market-Aware Position Sizing: Risk amount now varies based on:
    - 3H Market Trend: BULL vs BEAR (from 3H PP SuperTrend)
    - Position Direction: LONG vs SHORT (from 5m/15m PP SuperTrend)
  2. Risk Logic:
    - Bear Market: Favor SHORT positions ($300) over LONG positions ($100)
    - Bull Market: Favor LONG positions ($300) over SHORT positions ($100)
  3. Improved R/R Calculation: Now uses the actual dynamic risk amount instead of fixed $100

  How It Works:

  - In a BEAR market with a SHORT signal: Bot risks $300 per trade
  - In a BEAR market with a LONG signal: Bot risks $100 per trade
  - In a BULL market with a LONG signal: Bot risks $300 per trade
  - In a BULL market with a SHORT signal: Bot risks $100 per trade

  This aligns position sizing with market conditions - taking larger positions when trading WITH the trend and
  smaller positions when trading AGAINST the trend.


  2. backtest requirements

  can you double check why orignal backtest code result is so different with your latest? Pls    │
│   enhance the backtest code, make sure it is really work as my bot logic.                        │
│   and enhance backtest cmd support one time range:bt=01/04/2026 16:00:00,01/09/2026 16:00:00,    │
│   e.g.:                                                                                          │
│   ./backtest/scripts/bt_auto_trade_market.sh at=account1 fr=EUR_USD tf=5m bt=1/04/2026           │
│   16:00:00,01/09/2026 16:00:00                                                                   │
│   and please print out one new csv as your above output, filename:                               │
│   bt_EUR_USD_5m_account1_5d_20260109_142228_EUR_USD_5m_sign_ratio.csv                            │
│   sign, time,           highest_ratio,potential_profit,                                          │
│   sell,"Jan 4, 10:55pm",2.78:1, $3.94,                                                           │
╰────────────────────────────────────────

7. scalping trade strategy:
   1. when 5min/15mins' pp signal occurs,the bot follow previous definition logic calculate one enter price(call signal_price) and make a new order,
   2. after waiting a short period, it may reach my TP's RR(e.g.:0.6), when TP happen, the position be closed quickly. 
   3. after waiting a while, the instrument fill/runs the price back to signal_price (or cheapter the signal_price), 
   4. so I want the bot can catch up a new order(following existig same business logic to make the new order)
     I want the bot can repeat 2,3,4 limit between one input time range: 20pm to next-day 20AM (which are large volumnes in daily)
     If the bot run out of the time range, skip the scalping trade strategy, just keep its signal(5min/15mins's pp sign) trade strategy.

User answered Claude's questions:
  ⎿  · When should the bot re-enter after TP is hit? Should it wait until price touches the exact signal_price, or enter when price
     becomes cheaper (better entry for the direction)? → At or better than signal_price
     · What is the maximum number of scalping re-entries allowed per PP signal within the time window? → Unlimited
     · What timezone should the scalping window (8 PM to 8 AM) use? → US Pacific (PT)
     · If a new PP SuperTrend signal (trend reversal) occurs during the scalping window, what should happen? → Stop scalping, follow new
     signal

IMPLEMENTATION COMPLETED:
=========================
The scalping trade strategy has been implemented in src/trading_bot_market_aware.py:

Key Methods Added:
- is_in_scalping_window(): Checks if current time is within 8 PM - 8 AM Pacific Time
- start_scalping_mode(): Initializes scalping after first trade entry
- check_scalping_re_entry(): Detects when price returns to signal_price (or better)
- reset_scalping_state(): Clears scalping state on SL hit, new PP signal, or window end
- execute_scalping_re_entry(): Places re-entry order using original signal parameters

Configuration (src/config.yaml and account1/config.yaml):
```yaml
scalping:
  enabled: true  # Enable/disable per account
  time_window:
    start: "20:00"  # 8 PM Pacific
    end: "08:00"    # 8 AM Pacific (next day)
    timezone: "America/Los_Angeles"
  re_entry:
    use_limit_orders: true  # Use limit orders for precise entry
    price_buffer_pips: 0.5  # Buffer for limit order price
  max_entries_per_signal: 0  # 0 = unlimited
```

Flow:
1. PP signal triggers first trade -> scalping mode activates (if within time window)
2. TP hit -> position closes, bot monitors for price to return to signal_price
3. Price at/better than signal_price -> bot re-enters same direction
4. Repeat steps 2-3 unlimited times within time window
5. On SL hit or new PP signal -> scalping deactivates
6. Outside time window -> normal trading only

To enable: Set `scalping.enabled: true` in account config (already enabled in account1)