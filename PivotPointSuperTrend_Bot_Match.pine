//@version=5
indicator("Pivot Point SuperTrend - Bot Match", shorttitle="PP ST Bot", overlay=true)

// Input parameters - matching bot configuration exactly
pivot_period = input.int(2, title="Pivot Point Period", minval=1)
atr_factor = input.float(3.0, title="ATR Factor", step=0.1)
atr_period = input.int(10, title="ATR Period", minval=1)

// ATR Calculation
atr = ta.atr(atr_period)

// Pivot Point Detection Functions
detect_pivot_high(src, period) =>
    ph = ta.pivothigh(src, period, period)
    ph

detect_pivot_low(src, period) =>
    pl = ta.pivotlow(src, period, period)
    pl

// Calculate dynamic center line using pivot points
var float center = na
pivot_high = detect_pivot_high(high, pivot_period)
pivot_low = detect_pivot_low(low, pivot_period)

// Update center when new pivot is detected
if not na(pivot_high)
    center := na(center) ? pivot_high : (center * 2 + pivot_high) / 3
else if not na(pivot_low)
    center := na(center) ? pivot_low : (center * 2 + pivot_low) / 3

// Forward fill center line
center := na(center) ? close : center

// Calculate upper and lower bands
upper_band = center + (atr_factor * atr)
lower_band = center - (atr_factor * atr)

// SuperTrend calculation
var float trailing_up = na
var float trailing_down = na
var int trend = 1

// Calculate trailing stops
trailing_up := na(trailing_up[1]) ? lower_band : (close[1] > trailing_up[1] ? math.max(lower_band, trailing_up[1]) : lower_band)

trailing_down := na(trailing_down[1]) ? upper_band : (close[1] < trailing_down[1] ? math.min(upper_band, trailing_down[1]) : upper_band)

// Determine trend
prev_trend = trend[1]
if close > trailing_down[1]
    trend := 1
else if close < trailing_up[1]
    trend := -1
else
    trend := prev_trend

// SuperTrend line
supertrend = trend == 1 ? trailing_up : trailing_down

// Generate signals - exact matching bot logic
buy_signal = trend == 1 and trend[1] == -1
sell_signal = trend == -1 and trend[1] == 1

// Plot SuperTrend
plot(supertrend, title="SuperTrend", color=trend == 1 ? color.green : color.red, linewidth=2)

// Plot center line
plot(center, title="Pivot Center", color=color.yellow, linewidth=1, style=plot.style_line)

// Plot upper and lower bands (optional, for debugging)
plot_upper = plot(upper_band, title="Upper Band", color=color.new(color.gray, 80), display=display.none)
plot_lower = plot(lower_band, title="Lower Band", color=color.new(color.gray, 80), display=display.none)
fill(plot_upper, plot_lower, color=color.new(color.gray, 95))

// Plot pivot points
plotshape(pivot_high, title="Pivot High", style=shape.triangledown, location=location.abovebar, 
          color=color.red, size=size.tiny)
plotshape(pivot_low, title="Pivot Low", style=shape.triangleup, location=location.belowbar, 
          color=color.green, size=size.tiny)

// Plot buy/sell signals
plotshape(buy_signal, title="Buy Signal", style=shape.labelup, location=location.belowbar, 
          color=color.green, text="BUY", textcolor=color.white, size=size.normal)
plotshape(sell_signal, title="Sell Signal", style=shape.labeldown, location=location.abovebar, 
          color=color.red, text="SELL", textcolor=color.white, size=size.normal)

// Alerts
alertcondition(buy_signal, title="Buy Alert", message="PP SuperTrend BUY Signal")
alertcondition(sell_signal, title="Sell Alert", message="PP SuperTrend SELL Signal")

// Background color for trend
bgcolor_color = trend == 1 ? color.new(color.green, 95) : color.new(color.red, 95)
bgcolor(bgcolor_color, title="Trend Background")

// Table for debugging info
if barstate.islast
    var table debug_table = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)
    table.cell(debug_table, 0, 0, "Parameter", text_color=color.black)
    table.cell(debug_table, 1, 0, "Value", text_color=color.black)
    table.cell(debug_table, 0, 1, "Pivot Period", text_color=color.black)
    table.cell(debug_table, 1, 1, str.tostring(pivot_period), text_color=color.black)
    table.cell(debug_table, 0, 2, "ATR Factor", text_color=color.black)
    table.cell(debug_table, 1, 2, str.tostring(atr_factor), text_color=color.black)
    table.cell(debug_table, 0, 3, "ATR Period", text_color=color.black)
    table.cell(debug_table, 1, 3, str.tostring(atr_period), text_color=color.black)
    table.cell(debug_table, 0, 4, "Current Trend", text_color=color.black)
    table.cell(debug_table, 1, 4, trend == 1 ? "UP" : "DOWN", text_color=trend == 1 ? color.green : color.red)
    table.cell(debug_table, 0, 5, "SuperTrend", text_color=color.black)
    table.cell(debug_table, 1, 5, str.tostring(supertrend, "#.#####"), text_color=color.black)
    table.cell(debug_table, 0, 6, "Center", text_color=color.black)
    table.cell(debug_table, 1, 6, str.tostring(center, "#.#####"), text_color=color.black)
    table.cell(debug_table, 0, 7, "ATR", text_color=color.black)
    table.cell(debug_table, 1, 7, str.tostring(atr, "#.#####"), text_color=color.black)